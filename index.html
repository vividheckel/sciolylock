<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lockdown Exam</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding: 20px; }
#examContainer { display: none; }
</style>
</head>
<body>

<div id="loginContainer" class="container">
  <h2 class="mb-3">Exam Login</h2>
  <div class="mb-3">
    <label for="username" class="form-label">Username:</label>
    <input type="text" id="username" class="form-control" placeholder="Enter username">
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">Password:</label>
    <input type="password" id="password" class="form-control" placeholder="Enter password">
  </div>
  <button class="btn btn-primary" onclick="login()">Login</button>
</div>

<div id="examContainer" class="container">
  <div class="mb-3">
    <h4>Exam Progress</h4>
    <div class="progress">
      <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
           style="width: 100%">60:00</div>
    </div>
  </div>

  <div class="mb-3" id="status">Time out of focus: 0 seconds</div>

  <iframe id="googleForm" src="" frameborder="0" style="width:100%; height:600px;"></iframe>
  <button class="btn btn-success mt-3" onclick="submitExam()">Submit Exam</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let outOfFocusTime = parseFloat(localStorage.getItem('outOfFocusTime')) || 0;
let focusStart = null;
let timerInterval = null;
let countdownInterval = null;
let timeLeft = 3600; // 1 hour in seconds

function updateStatus() {
    document.getElementById('status').innerText = `Time out of focus: ${Math.floor(outOfFocusTime / 1000)} seconds`;
}
updateStatus();

// Visibility tracking
document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        focusStart = performance.now();
        timerInterval = setInterval(() => {
            let current = performance.now();
            outOfFocusTime += current - focusStart;
            focusStart = current;
            localStorage.setItem('outOfFocusTime', outOfFocusTime);
            updateStatus();
        }, 50);
    } else {
        if (focusStart) {
            outOfFocusTime += performance.now() - focusStart;
            focusStart = null;
            localStorage.setItem('outOfFocusTime', outOfFocusTime);
            updateStatus();
        }
        clearInterval(timerInterval);
    }
});

// Login function
async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    if (!username || !password) { alert("Enter username and password."); return; }

    try {
        const res = await fetch('https://scioly-backend.onrender.com/getForm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (!data.success) {
            alert("Invalid login.");
            return;
        }

        // Show exam
        document.getElementById('loginContainer').style.display = "none";
        document.getElementById('examContainer').style.display = "block";
        document.getElementById('googleForm').src = data.formLink;

        startExam();
    } catch (err) {
        console.error(err);
        alert("Failed to fetch form link.");
    }
}

// Exam start
function startExam() {
    // Fullscreen
    if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen().catch(err => console.log(err));
    }

    // Disable shortcuts
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
        if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'i') ||
            (e.ctrlKey && ['w','r','t'].includes(e.key.toLowerCase()) && e.ctrlKey)) {
            e.preventDefault();
            alert("Shortcut disabled in exam mode.");
        }
    });

    // Countdown + progress bar
    updateProgressBar();
    countdownInterval = setInterval(() => {
        timeLeft--;
        updateProgressBar();
        if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            alert("Time is up! Auto-submitting exam.");
            submitExam();
        }
    }, 1000);
}

function updateProgressBar() {
    const progress = (timeLeft / 3600) * 100;
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const bar = document.getElementById('progressBar');
    bar.style.width = progress + "%";
    bar.innerText = `${minutes}:${seconds.toString().padStart(2,'0')}`;
}

// Submit exam
function submitExam() {
    // Finalize out-of-focus time
    if (focusStart) {
        outOfFocusTime += performance.now() - focusStart;
        focusStart = null;
    }

    // Send data to backend
    fetch('https://scioly-backend.onrender.com/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            username: document.getElementById('username').value,
            outOfBrowserTimeMs: Math.floor(outOfFocusTime),
            timestamp: new Date().toISOString()
        })
    })
    .then(res => res.json())
    .then(data => {
        alert(`Exam submitted!\nOut-of-browser time: ${Math.floor(outOfFocusTime / 1000)} seconds`);

        // Reset everything
        clearInterval(countdownInterval);
        clearInterval(timerInterval);
        outOfFocusTime = 0;
        timeLeft = 3600;
        localStorage.removeItem('outOfFocusTime');

        // Exit fullscreen and reload page for fresh start
        if (document.fullscreenElement) document.exitFullscreen();
        location.reload();
    })
    .catch(err => {
        console.error(err);
        alert("Failed to send data to backend.");
    });
}
</script>
</body>
</html>
