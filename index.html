<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lockdown Exam</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: #121212;
    color: #e0e0e0;
  }

  #examContainer {
    display: none;
    height: 100vh;
    flex-direction: row;
  }

  #sidebar {
    width: 300px;
    background-color: #1e1e1e;
    padding: 20px;
    border-right: 1px solid #333;
    overflow-y: auto;
  }

  #questionsWrapper {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
  }

  .question {
    margin-bottom: 20px;
    background: #1f1f1f;
    padding: 15px;
    border-radius: 8px;
  }

  .flag-btn {
    cursor: pointer;
  }

  .sidebar-question {
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
    margin-bottom: 3px;
  }

  .sidebar-question.flagged {
    background-color: #ff9800;
    color: #000;
  }

  .sidebar-question.answered {
    font-weight: bold;
  }

  input, select, button {
    background-color: #2c2c2c;
    color: #e0e0e0;
    border: 1px solid #555;
  }

  input:disabled, select:disabled {
    background-color: #3a3a3a;
  }

  .form-check-label {
    cursor: pointer;
  }

  .progress {
    height: 25px;
    background-color: #333;
  }

  .progress-bar {
    background-color: #4caf50;
  }
</style>
</head>
<body>

<div id="loginContainer" class="container p-5">
  <h2 class="mb-3">Exam Login</h2>
  <div class="mb-3">
    <label for="username" class="form-label">Username:</label>
    <input type="text" id="username" class="form-control" placeholder="Enter username">
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">Password:</label>
    <input type="password" id="password" class="form-control" placeholder="Enter password">
  </div>
  <button type="button" class="btn btn-primary" onclick="login()">Login</button>
</div>

<div id="examContainer">
  <div id="sidebar">
    <h4>Timer</h4>
    <div class="progress">
        <div class="progress-bar progress-bar-striped" style="width:100%" id="progressBar">
            <span id="timerText">60:00</span>
        </div>
    </div>
    <div id="focusStatus">Time out of focus: 0 sec</div>
    <div id="answeredStatus" class="mt-2">Answered 0/0</div>
    <h5 class="mt-4">Questions</h5>
    <div id="sidebarQuestions"></div>
  </div>

  <div id="questionsWrapper">
    <div id="questionsContainer"></div>
    <button type="button" class="btn btn-success mt-3" onclick="submitExam()">Submit Exam</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE = 'http://localhost:3000';

let outOfFocusTime = 0;
let focusStart = null;
let timerInterval = null;
let countdownInterval = null;
let timeLeft = 3600; // 1 hour
let answers = {};
let flagged = {};
let testName = '';
let questionsList = [];
let outOfFocusSubmitted = false;

window.addEventListener('DOMContentLoaded', () => {
    const savedUsername = localStorage.getItem('exam_username');
    const savedTest = localStorage.getItem('exam_test');
    const inProgress = localStorage.getItem('exam_inProgress') === 'true';

    // Only resume exam if flag is true
    if (savedUsername && savedTest && inProgress) {
        document.getElementById('username').value = savedUsername;
        testName = savedTest;
        resumeExam(savedUsername, savedTest);
    }
});


async function resumeExam(username, test) {
    try {
        const qRes = await fetch(`${API_BASE}/startTest`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username,test,numQuestions:5})
        });
        const qData = await qRes.json();
        if (!qData.success) { 
            alert("No exam available!"); 
            localStorage.setItem('exam_inProgress', 'false'); // mark exam as not in progress
            return; 
        }

        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('examContainer').style.display = 'flex';
        answers = loadProgress();
        const savedOutOfFocus = localStorage.getItem(`exam_outOfFocus_${username}_${testName}`);
        if (savedOutOfFocus) outOfFocusTime = parseInt(savedOutOfFocus, 10);
        questionsList = qData.questions;
        renderQuestions(questionsList, answers);
        startExam();
    } catch (err) { console.error(err); alert("Failed to load exam."); }
}

function updateStatus() {
    document.getElementById('focusStatus').innerText = `Time out of focus: ${Math.floor(outOfFocusTime/1000)} sec`;
    updateAnsweredCount();
}

function updateAnsweredCount() {
    const total = questionsList.length;
    const answered = Object.keys(answers).filter(k => answers[k] && answers[k] !== '').length;
    document.getElementById('answeredStatus').innerText = `Answered ${answered}/${total}`;
}

function saveProgress() {
    const username = document.getElementById('username').value;
    localStorage.setItem(`exam_answers_${username}_${testName}`, JSON.stringify(answers));
    localStorage.setItem(`exam_timeLeft_${username}_${testName}`, timeLeft);
    localStorage.setItem(`exam_outOfFocus_${username}_${testName}`, outOfFocusTime);
}

function loadProgress() {
    const username = document.getElementById('username').value;
    if (!username || !testName) return {};

    const savedAnswers = localStorage.getItem(`exam_answers_${username}_${testName}`);
    const savedTimeLeft = localStorage.getItem(`exam_timeLeft_${username}_${testName}`);
    const savedOutOfFocus = localStorage.getItem(`exam_outOfFocus_${username}_${testName}`);

    if (savedTimeLeft) timeLeft = parseInt(savedTimeLeft, 10);
    if (savedOutOfFocus) outOfFocusTime = parseInt(savedOutOfFocus, 10);

    return savedAnswers ? JSON.parse(savedAnswers) : {};
}

document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
        focusStart = performance.now();
        timerInterval = setInterval(() => {
            let current = performance.now();
            outOfFocusTime += current - focusStart;
            focusStart = current;
            updateStatus();
        }, 50);
    } else {
        if (focusStart) {
            outOfFocusTime += performance.now() - focusStart;
            focusStart = null;
            updateStatus();
        }
        clearInterval(timerInterval);
    }
});

async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    if (!username || !password) { alert("Enter username and password."); return; }

    try {
        const res = await fetch(`${API_BASE}/login`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username,password})
        });
        const data = await res.json();
        if (!data.success) { alert("Invalid username or password."); return; }
        testName = data.test;

        // Save session
        localStorage.setItem('exam_username', username);
        localStorage.setItem('exam_test', testName);
        localStorage.setItem('exam_inProgress', 'true'); // mark exam in progress

        resumeExam(username, testName);
    } catch (err) { console.error(err); alert("Login failed due to network or server error."); }
}

function renderQuestions(questions, savedAnswers={}) {
    const container = document.getElementById('questionsContainer');
    container.innerHTML = '';
    flagged = {};
    questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = 'question';
        div.id = `questionDiv_${q.id}`;

        const saved = savedAnswers[q.id] || '';
        answers[q.id] = saved;

        let html = `<p><strong>Q${index+1}:</strong> ${q.question_text}</p>`;
        if (q.multimedia_content) {
            html += `<img src="${q.multimedia_content}" class="img-fluid mb-2" alt="Question image" style="max-width:400px; max-height:300px;">`;
        }

        if (q.type === "mcq" && q.options) {
            q.options.forEach((opt,i)=>{
                const checked = saved === opt ? 'checked' : '';
                html += `<div class="form-check">
                    <input class="form-check-input" type="radio" name="question_${q.id}" value="${opt}" ${checked}
                        onchange="answers[${q.id}]=this.value; saveProgress(); updateAnsweredCount();">
                    <label class="form-check-label">${opt}</label>
                </div>`;
            });
        } else {
            html += `<input type="text" class="form-control" value="${saved}"
                oninput="answers[${q.id}]=this.value; saveProgress(); updateAnsweredCount();"
                oncopy="return false;" onpaste="return false;" oncut="return false;">`;
        }

        html += `<button type="button" class="btn btn-warning btn-sm mt-2 flag-btn" onclick="toggleFlag(${q.id})">Flag for Review</button>`;
        div.innerHTML = html;
        container.appendChild(div);
    });
    renderSidebarQuestions();
    updateAnsweredCount();
}

function toggleFlag(qid) {
    flagged[qid] = !flagged[qid];
    const btn = document.querySelector(`#questionDiv_${qid} .flag-btn`);
    if (btn) btn.innerText = flagged[qid] ? "Unflag" : "Flag for Review";
    renderSidebarQuestions();
}

function renderSidebarQuestions() {
    const sidebar = document.getElementById('sidebarQuestions');
    sidebar.innerHTML = '';
    questionsList.forEach((q,index)=>{
        const div = document.createElement('div');
        div.className = 'sidebar-question';
        if (flagged[q.id]) div.classList.add('flagged');
        if (answers[q.id] && answers[q.id] !== '') div.classList.add('answered');
        div.innerText = `Q${index+1}`;
        div.onclick = ()=>document.getElementById(`questionDiv_${q.id}`)?.scrollIntoView({behavior:'smooth'});
        sidebar.appendChild(div);
    });
}

function startExam() {
    const username = document.getElementById('username').value;
    const savedOutOfFocus = localStorage.getItem(`exam_outOfFocus_${username}_${testName}`);
    if (savedOutOfFocus) {
        outOfFocusTime = parseInt(savedOutOfFocus, 10);
    } else {
        outOfFocusTime = 0;
    }

    outOfFocusSubmitted = false;
    focusStart = document.hidden ? performance.now() : null;

    updateStatus();

    document.addEventListener('contextmenu', e=>e.preventDefault());
    document.addEventListener('keydown', e=>{
        if (e.key==='F12' || (e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='i') ||
            (e.ctrlKey && ['w','r','t'].includes(e.key.toLowerCase()))) {
            e.preventDefault(); alert("Shortcut disabled.");
        }
    });

    // === Reliable exam timer ===
    let lastTick = Date.now();

    timerInterval = setInterval(() => {
        const now = Date.now();
        const delta = Math.floor((now - lastTick) / 1000);
        if (delta > 0) {
            timeLeft -= delta;
            lastTick = now;

            if (timeLeft <= 0) {
                timeLeft = 0;
                clearInterval(timerInterval);
                updateTimerUI();
                alert("Exam time is over!");
                submitExam();
                return;
            }

            updateTimerUI();
            saveProgress();
            updateStatus();
        }
    }, 1000);

    updateTimerUI(); // initial display
}

function updateTimerUI() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('timerText').innerText = `${minutes}:${seconds.toString().padStart(2,'0')}`;
    document.getElementById('progressBar').style.width = ((timeLeft / 3600) * 100) + '%';
}

async function submitExam() {
    if (!confirm("Are you sure you want to submit the exam?")) return;

    if (focusStart) outOfFocusTime += Date.now() - focusStart;
    const username = document.getElementById('username').value;

    try {
        const res = await fetch(`${API_BASE}/submitTest`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                username,
                testName,
                outOfBrowserTimeMs: Math.floor(outOfFocusTime),
                answers: Object.entries(answers).map(([qid,ans])=>({questionId:Number(qid),answer:ans}))
            })
        });
        const data = await res.json();
        if (!data.success) { alert("Submit failed"); return; }

        alert("Exam submitted!");
        // Clear progress and in-progress flag
        localStorage.removeItem(`exam_answers_${username}_${testName}`);
        localStorage.removeItem(`exam_timeLeft_${username}_${testName}`);
        localStorage.removeItem(`exam_outOfFocus_${username}_${testName}`);
        localStorage.removeItem('exam_username');
        localStorage.removeItem('exam_test');
        localStorage.setItem('exam_inProgress', 'false');

        clearInterval(countdownInterval); 
        clearInterval(timerInterval); 
        outOfFocusTime=0; timeLeft=3600; answers={};
        if (document.fullscreenElement) document.exitFullscreen();

        document.getElementById('examContainer').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
    } catch(err) { console.error(err); alert("Submit failed"); }
}

</script>
</body>
</html>