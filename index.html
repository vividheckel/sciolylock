<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lockdown Exam</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: #121212;
    color: #e0e0e0;
  }

  .container {
    max-width: 800px;
    padding: 40px 20px;
  }

  #examContainer {
    display: none;
    height: 100vh;
    flex-direction: row;
  }

  #sidebar {
    width: 300px;
    background-color: #1e1e1e;
    padding: 20px;
    border-right: 1px solid #333;
    overflow-y: auto;
  }

  #questionsWrapper {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
  }

  .question {
    margin-bottom: 20px;
    background: #1f1f1f;
    padding: 15px;
    border-radius: 8px;
  }

  .question.correct {
    border-left: 4px solid #4caf50;
  }

  .question.incorrect {
    border-left: 4px solid #f44336;
  }

  .question.pending {
    border-left: 4px solid #ff9800;
  }

  .flag-btn {
    cursor: pointer;
  }

  .sidebar-question {
    cursor: pointer;
    padding: 5px;
    border-radius: 5px;
    margin-bottom: 3px;
  }

  .sidebar-question.flagged {
    background-color: #ff9800;
    color: #000;
  }

  .sidebar-question.answered {
    font-weight: bold;
  }

  input, select, button, textarea {
    background-color: #2c2c2c;
    color: #e0e0e0;
    border: 1px solid #555;
  }

  textarea {
    min-height: 150px;
    font-family: inherit;
  }

  input:disabled, select:disabled, textarea:disabled {
    background-color: #3a3a3a;
  }

  .form-check-label {
    cursor: pointer;
  }

  .progress {
    height: 25px;
    background-color: #333;
  }

  .progress-bar {
    background-color: #4caf50;
  }

  .test-card {
    background-color: #1e1e1e;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  .test-card:hover {
    background-color: #2a2a2a;
  }

  .test-card.submitted {
    border-left: 4px solid #4caf50;
  }

  .test-card.pending {
    border-left: 4px solid #ff9800;
  }

  .badge-custom {
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.85em;
  }

  .badge-submitted {
    background-color: #4caf50;
  }

  .badge-pending {
    background-color: #ff9800;
  }

  .practice-mode-banner {
    background-color: #2196f3;
    padding: 10px;
    text-align: center;
    font-weight: bold;
    margin-bottom: 20px;
  }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginContainer" class="container p-5">
  <h2 class="mb-3">Exam Login</h2>
  <div class="mb-3">
    <label for="username" class="form-label">Username:</label>
    <input type="text" id="username" class="form-control" placeholder="Enter username">
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">Password:</label>
    <input type="password" id="password" class="form-control" placeholder="Enter password">
  </div>
  <button type="button" class="btn btn-primary" onclick="login()">Login</button>
  <div id="loginMessage" class="mt-2 text-danger"></div>
</div>

<!-- TEST SELECTION -->
<div id="testSelectionContainer" class="container" style="display:none;">
  <h2 class="mb-4">Select a Test</h2>
  <div id="testList"></div>
  <button type="button" class="btn btn-secondary mt-3" onclick="logout()">Logout</button>
</div>

<!-- EXAM INTERFACE -->
<div id="examContainer">
  <div id="sidebar">
    <div id="practiceModeBanner" class="practice-mode-banner" style="display:none;">
      PRACTICE MODE - Review & Improve
    </div>
    <h4>Timer</h4>
    <div class="progress">
        <div class="progress-bar progress-bar-striped" style="width:100%" id="progressBar">
            <span id="timerText">60:00</span>
        </div>
    </div>
    <div id="focusStatus">Time out of focus: 0 sec</div>
    <div id="answeredStatus" class="mt-2">Answered 0/0</div>
    <h5 class="mt-4">Questions</h5>
    <div id="sidebarQuestions"></div>
  </div>

  <div id="questionsWrapper">
    <div id="questionsContainer"></div>
    <button type="button" class="btn btn-success mt-3" onclick="submitExam()">Submit Exam</button>
    <button type="button" class="btn btn-secondary mt-3 ms-2" onclick="backToTestSelection()">Back to Tests</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE = 'http://localhost:3000';

let currentUsername = '';
let outOfFocusTime = 0;
let focusStart = null;
let timerInterval = null;
let timeLeft = 3600;
let answers = {};
let flagged = {};
let testName = '';
let questionsList = [];
let isPracticeMode = false;
let examStartTime = null;

async function login() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const msg = document.getElementById('loginMessage');
    
    if (!username || !password) { 
        msg.innerText = "Enter username and password."; 
        return; 
    }

    try {
        const res = await fetch(`${API_BASE}/login`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username,password})
        });
        const data = await res.json();
        
        if (!data.success) { 
            msg.innerText = data.error || "Invalid username or password."; 
            return; 
        }

        currentUsername = username;
        
        if (data.tests && data.tests.length > 0) {
            showTestSelection(data.tests);
        } else {
            msg.innerText = "No tests assigned to you.";
        }
    } catch (err) { 
        console.error(err); 
        msg.innerText = "Login failed due to network or server error."; 
    }
}

function showTestSelection(tests) {
    document.getElementById('loginContainer').style.display = 'none';
    document.getElementById('testSelectionContainer').style.display = 'block';
    
    const testList = document.getElementById('testList');
    testList.innerHTML = '';
    
    tests.forEach(test => {
        const card = document.createElement('div');
        card.className = `test-card ${test.submitted ? 'submitted' : 'pending'}`;
        
        let statusBadge = test.submitted 
            ? `<span class="badge-custom badge-submitted">Submitted - Score: ${test.score?.toFixed(1)}%</span>`
            : `<span class="badge-custom badge-pending">Not Started</span>`;
        
        let practiceButton = test.submitted
            ? `<button class="btn btn-sm btn-info ms-2" onclick="startTest('${test.testName}', true)">Practice Mode</button>`
            : '';
        
        card.innerHTML = `
            <h4>${test.testName}</h4>
            ${statusBadge}
            ${practiceButton}
            ${!test.submitted ? `<button class="btn btn-sm btn-primary ms-2" onclick="startTest('${test.testName}', false)">Start Test</button>` : ''}
        `;
        
        testList.appendChild(card);
    });
}

async function startTest(test, practice) {
    testName = test;
    isPracticeMode = practice;
    examStartTime = new Date();
    
    try {
        const res = await fetch(`${API_BASE}/startTest`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username: currentUsername, test, isPractice: practice})
        });
        const data = await res.json();
        
        if (!data.success) { 
            alert(data.error || "Failed to start test"); 
            return; 
        }

        document.getElementById('testSelectionContainer').style.display = 'none';
        document.getElementById('examContainer').style.display = 'flex';
        
        if (isPracticeMode) {
            document.getElementById('practiceModeBanner').style.display = 'block';
            document.getElementById('timerText').parentElement.innerHTML = 'No Time Limit';
        } else {
            document.getElementById('practiceModeBanner').style.display = 'none';
        }
        
        questionsList = data.questions;
        answers = {};
        flagged = {};
        
        renderQuestions(questionsList);
        
        if (!isPracticeMode) {
            startExamLockdown();
        }
    } catch (err) { 
        console.error(err); 
        alert("Failed to load exam."); 
    }
}

function renderQuestions(questions) {
    const container = document.getElementById('questionsContainer');
    container.innerHTML = '';
    
    questions.forEach((q, index) => {
        const div = document.createElement('div');
        div.className = 'question';
        div.id = `questionDiv_${q.id}`;
        
        // In practice mode, show correctness
        if (isPracticeMode) {
            if (q.wasCorrect === true) {
                div.classList.add('correct');
            } else if (q.wasCorrect === false) {
                div.classList.add('incorrect');
            } else if (q.previousManualScore !== null && q.previousManualScore !== undefined) {
                if (q.previousManualScore > 0) {
                    div.classList.add('correct');
                } else {
                    div.classList.add('incorrect');
                }
            } else {
                div.classList.add('pending');
            }
        }
        
        const saved = q.previousAnswer || '';
        answers[q.id] = saved;

        let html = `<p><strong>Q${index+1}:</strong> ${q.question_text}</p>`;
        
        if (isPracticeMode) {
            let statusText = '';
            if (q.wasCorrect === true) {
                statusText = '<span class="text-success">✓ Correct</span>';
            } else if (q.wasCorrect === false) {
                statusText = '<span class="text-danger">✗ Incorrect</span>';
            } else if (q.previousManualScore !== null && q.previousManualScore !== undefined) {
                statusText = `<span class="text-info">Manually Graded: ${q.previousManualScore}</span>`;
            } else {
                statusText = '<span class="text-warning">Pending Manual Grading</span>';
            }
            html += `<p>${statusText}</p>`;
        }
        
        if (q.multimedia_content) {
            html += `<img src="${q.multimedia_content}" class="img-fluid mb-2" alt="Question image" style="max-width:400px; max-height:300px;">`;
        }

        if (q.type === "mcq" && q.options) {
            q.options.forEach((opt,i)=>{
                const checked = saved === opt ? 'checked' : '';
                html += `<div class="form-check">
                    <input class="form-check-input" type="radio" name="question_${q.id}" value="${opt}" ${checked}
                        onchange="answers[${q.id}]=this.value; updateAnsweredCount();">
                    <label class="form-check-label">${opt}</label>
                </div>`;
            });
        } else {
            // Large text area for free response
            html += `<textarea class="form-control" oninput="answers[${q.id}]=this.value; updateAnsweredCount();"
                oncopy="return ${isPracticeMode};" onpaste="return ${isPracticeMode};" oncut="return ${isPracticeMode};">${saved}</textarea>`;
        }

        if (!isPracticeMode) {
            html += `<button type="button" class="btn btn-warning btn-sm mt-2 flag-btn" onclick="toggleFlag(${q.id})">Flag for Review</button>`;
        }
        
        div.innerHTML = html;
        container.appendChild(div);
    });
    
    renderSidebarQuestions();
    updateAnsweredCount();
}

function toggleFlag(qid) {
    flagged[qid] = !flagged[qid];
    const btn = document.querySelector(`#questionDiv_${qid} .flag-btn`);
    if (btn) btn.innerText = flagged[qid] ? "Unflag" : "Flag for Review";
    renderSidebarQuestions();
}

function renderSidebarQuestions() {
    const sidebar = document.getElementById('sidebarQuestions');
    sidebar.innerHTML = '';
    questionsList.forEach((q,index)=>{
        const div = document.createElement('div');
        div.className = 'sidebar-question';
        if (flagged[q.id]) div.classList.add('flagged');
        if (answers[q.id] && answers[q.id] !== '') div.classList.add('answered');
        div.innerText = `Q${index+1}`;
        div.onclick = ()=>document.getElementById(`questionDiv_${q.id}`)?.scrollIntoView({behavior:'smooth'});
        sidebar.appendChild(div);
    });
}

function updateAnsweredCount() {
    const total = questionsList.length;
    const answered = Object.keys(answers).filter(k => answers[k] && answers[k] !== '').length;
    document.getElementById('answeredStatus').innerText = `Answered ${answered}/${total}`;
}

function startExamLockdown() {
    outOfFocusTime = 0;
    focusStart = document.hidden ? performance.now() : null;

    updateStatus();

    document.addEventListener('contextmenu', e=>e.preventDefault());
    document.addEventListener('keydown', e=>{
        if (e.key==='F12' || (e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='i') ||
            (e.ctrlKey && ['w','r','t'].includes(e.key.toLowerCase()))) {
            e.preventDefault(); 
            alert("Shortcut disabled.");
        }
    });

    document.addEventListener("visibilitychange", handleVisibilityChange);

    let lastTick = Date.now();
    timerInterval = setInterval(() => {
        const now = Date.now();
        const delta = Math.floor((now - lastTick) / 1000);
        if (delta > 0) {
            timeLeft -= delta;
            lastTick = now;

            if (timeLeft <= 0) {
                timeLeft = 0;
                clearInterval(timerInterval);
                updateTimerUI();
                alert("Exam time is over!");
                submitExam();
                return;
            }

            updateTimerUI();
        }
    }, 1000);

    updateTimerUI();
}

function handleVisibilityChange() {
    if (document.hidden) {
        focusStart = performance.now();
    } else {
        if (focusStart) {
            outOfFocusTime += performance.now() - focusStart;
            focusStart = null;
            updateStatus();
        }
    }
}

function updateStatus() {
    document.getElementById('focusStatus').innerText = `Time out of focus: ${Math.floor(outOfFocusTime/1000)} sec`;
}

function updateTimerUI() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('timerText').innerText = `${minutes}:${seconds.toString().padStart(2,'0')}`;
    document.getElementById('progressBar').style.width = ((timeLeft / 3600) * 100) + '%';
}

async function submitExam() {
    if (!confirm(isPracticeMode ? "Submit your updated answers?" : "Are you sure you want to submit the exam?")) return;

    if (!isPracticeMode && focusStart) {
        outOfFocusTime += Date.now() - focusStart;
    }

    const examEndTime = new Date();

    try {
        const res = await fetch(`${API_BASE}/submitTest`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                username: currentUsername,
                testName,
                outOfBrowserTimeMs: Math.floor(outOfFocusTime),
                answers: Object.entries(answers).map(([qid,ans])=>({questionId:Number(qid),answer:ans})),
                isPractice: isPracticeMode,
                startTime: examStartTime,
                endTime: examEndTime
            })
        });
        const data = await res.json();
        
        if (!data.success) { 
            alert("Submit failed"); 
            return; 
        }

        if (isPracticeMode) {
            alert(`Practice submission complete! Your updated score: ${data.totalScore?.toFixed(1)}%`);
        } else {
            alert(`Exam submitted! Your score: ${data.totalScore?.toFixed(1)}%`);
        }

        backToTestSelection();
    } catch(err) { 
        console.error(err); 
        alert("Submit failed"); 
    }
}

function backToTestSelection() {
    clearInterval(timerInterval);
    document.removeEventListener("visibilitychange", handleVisibilityChange);
    
    outOfFocusTime = 0;
    timeLeft = 3600;
    answers = {};
    flagged = {};
    
    document.getElementById('examContainer').style.display = 'none';
    
    // Reload test list
    login();
}

function logout() {
    document.getElementById('testSelectionContainer').style.display = 'none';
    document.getElementById('loginContainer').style.display = 'block';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    currentUsername = '';
}
</script>
</body>
</html>