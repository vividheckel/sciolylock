<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grader Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: #121212;
    color: #e0e0e0;
  }

  .container {
    max-width: 1200px;
  }

  h1, h3 {
    color: #fff;
  }

  .section {
    margin-bottom: 40px;
    background-color: #1e1e1e;
    padding: 20px;
    border-radius: 10px;
  }

  input, select, button {
    background-color: #2c2c2c;
    color: #e0e0e0;
    border: 1px solid #555;
  }

  input:disabled, select:disabled {
    background-color: #3a3a3a;
  }

  table {
    color: #e0e0e0;
  }

  table th, table td {
    vertical-align: middle;
  }

  #lockScreen {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background-color: #121212;
    display:flex;
    justify-content:center;
    align-items:center;
    z-index: 9999;
    flex-direction: column;
    color: #fff;
  }
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="lockScreen">
  <h2>Grader Login</h2>
  <input type="text" id="graderUsername" class="form-control mb-3" placeholder="Username" style="width: 250px; max-width: 90%;">
  <input type="password" id="graderPassword" class="form-control mb-3" placeholder="Password" style="width: 250px; max-width: 90%;">
  <button class="btn btn-primary" onclick="loginGrader()">Login</button>
  <div id="lockMsg" class="mt-2 text-danger"></div>
</div>

<div id="dashboard" class="container" style="display:none;">
  <h1 class="mb-4">Grader Dashboard</h1>
  <p>Logged in as: <strong id="currentGrader"></strong> | <button class="btn btn-sm btn-secondary" onclick="logoutGrader()">Logout</button></p>

  <!-- MY ASSIGNMENTS -->
  <div class="section">
    <h3>My Assigned Submissions</h3>
    <button class="btn btn-info mb-3" onclick="loadMyAssignments()">Load Assignments</button>
    <div id="assignmentsContainer"></div>
  </div>

  <!-- VIEW & GRADE ANSWERS -->
  <div class="section">
    <h3>View & Grade Submission</h3>
    <div class="row g-3 mb-2">
      <div class="col-md-4">
        <input type="text" id="viewUsername" class="form-control" placeholder="Username">
      </div>
      <div class="col-md-4">
        <input type="text" id="viewTestName" class="form-control" placeholder="Test Name">
      </div>
      <div class="col-md-4">
        <button class="btn btn-info w-100" onclick="viewUserAnswers()">View Answers</button>
      </div>
    </div>
    <div id="answersContainer" class="mt-2" style="background-color: #2c2c2c; padding: 15px; border-radius: 8px; overflow-x: auto;"></div>
    <div id="finalScore" class="mt-2" style="background-color: #2c2c2c; padding: 15px; border-radius: 8px;"></div>
  </div>

  <!-- RANKINGS -->
  <div class="section">
    <h3>Test Rankings</h3>
    <div class="row g-3 mb-2">
      <div class="col-md-6"><input type="text" id="rankingTestName" class="form-control" placeholder="Test Name"></div>
      <div class="col-md-6"><button class="btn btn-info" onclick="viewRankings()">View Rankings</button></div>
    </div>
    <div id="rankingContainer" class="mt-2" style="background-color: #2c2c2c; padding: 15px; border-radius: 8px;"></div>
  </div>
</div>

<script>
const API_BASE = 'http://localhost:3000';
let graderToken = null;
let currentGraderName = '';

async function loginGrader() {
    const username = document.getElementById('graderUsername').value.trim();
    const password = document.getElementById('graderPassword').value;
    const msg = document.getElementById('lockMsg');
    
    if (!username || !password) {
        msg.innerText = "Enter username and password";
        return;
    }

    try {
        const res = await fetch(`${API_BASE}/graderLogin`, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        
        if (data.success && data.token) {
            graderToken = data.token;
            currentGraderName = data.username;
            document.getElementById('currentGrader').innerText = currentGraderName;
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadMyAssignments();
        } else {
            msg.innerText = data.error || "Invalid credentials";
        }
    } catch(err) {
        msg.innerText = "Network error";
    }
}

function logoutGrader() {
    graderToken = null;
    currentGraderName = '';
    document.getElementById('lockScreen').style.display = 'flex';
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('graderUsername').value = '';
    document.getElementById('graderPassword').value = '';
}

function authHeaders() {
    return {
        'Content-Type':'application/json',
        'Authorization': `Bearer ${graderToken}`
    };
}

async function loadMyAssignments() {
    const container = document.getElementById('assignmentsContainer');
    container.innerHTML = "Loading...";

    try {
        const res = await fetch(`${API_BASE}/myAssignments`, { 
            headers: authHeaders() 
        });
        const data = await res.json();

        if (!data.success) {
            container.innerText = `Error: ${data.error}`;
            return;
        }

        if (!data.assignments || data.assignments.length === 0) {
            container.innerText = "No assignments found.";
            return;
        }

        let html = '<table class="table table-striped table-dark"><thead><tr><th>Username</th><th>Test</th><th>Score</th><th>Submitted</th><th>Actions</th></tr></thead><tbody>';
        data.assignments.forEach(a => {
            const submittedDate = a.timestamp ? new Date(a.timestamp).toLocaleString() : 'N/A';
            html += `<tr>
                <td>${a.username}</td>
                <td>${a.testName}</td>
                <td>${a.score?.toFixed(2) || 'N/A'}%</td>
                <td>${submittedDate}</td>
                <td><button class="btn btn-sm btn-primary" onclick="gradeSubmission('${a.username}','${a.testName}')">Grade</button></td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    } catch (err) {
        container.innerText = `Network error: ${err.message}`;
    }
}

function gradeSubmission(username, testName) {
    document.getElementById('viewUsername').value = username;
    document.getElementById('viewTestName').value = testName;
    viewUserAnswers();
}

async function viewUserAnswers() {
    const username = document.getElementById('viewUsername').value.trim();
    const testName = document.getElementById('viewTestName').value.trim();
    const container = document.getElementById('answersContainer');
    const scoreContainer = document.getElementById('finalScore');

    container.innerHTML = scoreContainer.innerHTML = "Loading...";

    if (!username || !testName) {
        container.innerText = "Username and Test Name required";
        scoreContainer.innerText = "";
        return;
    }

    try {
        const url = `${API_BASE}/viewUserAnswers/${encodeURIComponent(username)}/${encodeURIComponent(testName)}`;
        const res = await fetch(url, { headers: authHeaders() });
        const data = await res.json();

        if (!data.success) {
            container.innerText = `Error: ${data.error}`;
            scoreContainer.innerText = "";
            return;
        }

        if (!data.answers || data.answers.length === 0) {
            container.innerText = "No submissions found";
            scoreContainer.innerText = "";
            return;
        }

        let totalPointsEarned = 0;
        let totalPointsPossible = 0;

        let html = `<table class="table table-striped table-dark">
                    <thead><tr>
                        <th>ID</th>
                        <th>Question</th>
                        <th>User Answer</th>
                        <th>Correct Answer</th>
                        <th>Status</th>
                        <th>Points (Max: shown)</th>
                        <th>Manual Score</th>
                    </tr></thead><tbody>`;

        data.answers.forEach((a, index) => {
            const userAnswer = a.submittedAnswer || "No Answer";
            const correctAnswer = a.correctAnswer || "Manually Graded";
            const maxPoints = a.maxPoints || 1;
            totalPointsPossible += maxPoints;
            
            let statusText = "";
            let pointsEarned = 0;

            if (a.manualScore !== null && a.manualScore !== undefined) {
                statusText = "Manually graded";
                pointsEarned = a.manualScore;
                totalPointsEarned += pointsEarned;
            } else if (a.isCorrect === true) {
                statusText = "Correct";
                pointsEarned = maxPoints;
                totalPointsEarned += pointsEarned;
            } else if (a.isCorrect === false) {
                statusText = "Incorrect";
                pointsEarned = 0;
            } else {
                statusText = "Pending Manual Grading";
                pointsEarned = 0;
            }

            const scoreValue = a.manualScore !== null && a.manualScore !== undefined ? a.manualScore : (a.isCorrect ? maxPoints : 0);

            html += `<tr>
                        <td>${a.questionId}</td>
                        <td>${a.questionText}</td>
                        <td>${userAnswer}</td>
                        <td>${correctAnswer}</td>
                        <td>${statusText}</td>
                        <td>${pointsEarned.toFixed(2)} / ${maxPoints}</td>
                        <td>
                            <input type="number" step="0.01" min="0" max="${maxPoints}" id="scoreInput_${index}" value="${scoreValue}" class="form-control w-75 d-inline-block">
                            <button class="btn btn-sm btn-success ms-2" onclick="submitManualScore('${username}','${testName}',${a.questionId},${index})">Save</button>
                            <span id="scoreMsg_${index}" class="ms-2 text-success"></span>
                        </td>
                     </tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;

        const percentScore = totalPointsPossible > 0 ? (totalPointsEarned / totalPointsPossible) * 100 : 0;
        const outOfBrowserSec = Math.floor((data.outOfBrowserTimeMs || 0) / 1000);
        
        const startTime = data.startTime ? new Date(data.startTime).toLocaleString() : 'N/A';
        const endTime = data.endTime ? new Date(data.endTime).toLocaleString() : 'N/A';
        const duration = data.duration ? Math.floor(data.duration / 1000 / 60) : 'N/A';
        
        scoreContainer.innerHTML = `
            <strong>${username}'s Final Score:</strong> ${percentScore.toFixed(2)}% (${totalPointsEarned.toFixed(2)} / ${totalPointsPossible} points)<br>
            <strong>Out-of-browser Time:</strong> ${outOfBrowserSec} seconds<br>
            <strong>Start Time:</strong> ${startTime}<br>
            <strong>End Time:</strong> ${endTime}<br>
            <strong>Duration:</strong> ${duration} minutes
        `;

    } catch (err) {
        container.innerText = `Network error: ${err.message}`;
        scoreContainer.innerText = "";
    }
}

async function submitManualScore(username, testName, questionId, index) {
    const input = document.getElementById(`scoreInput_${index}`);
    const msg = document.getElementById(`scoreMsg_${index}`);
    const score = parseFloat(input.value);

    if (isNaN(score) || score < 0) { 
        msg.innerText = "Enter a valid score"; 
        return; 
    }

    msg.innerText = "Saving...";
    try {
        const res = await fetch(`${API_BASE}/gradeQuestion`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ username, testName, questionId, scoreDelta: score })
        });
        const data = await res.json();
        if (data.success) {
            msg.innerText = `Saved! New total: ${data.newScore.toFixed(2)}%`;
            setTimeout(() => viewUserAnswers(), 1000);
        } else {
            msg.innerText = `Error: ${data.error}`;
        }
    } catch (err) { 
        msg.innerText = `Network error: ${err.message}`; 
    }
}

async function viewRankings() {
    const testName = document.getElementById('rankingTestName').value.trim();
    const container = document.getElementById('rankingContainer');

    if (!testName) { 
        container.innerText = "Test Name required"; 
        return; 
    }
    container.innerText = "Loading...";

    try {
        const res = await fetch(`${API_BASE}/rankings/${encodeURIComponent(testName)}`, { 
            headers: authHeaders() 
        });
        const data = await res.json();

        if (!data.success) { 
            container.innerText = `Error: ${data.error}`; 
            return; 
        }
        if (!data.rankings || data.rankings.length === 0) { 
            container.innerText = "No submissions yet."; 
            return; 
        }

        let html = '<table class="table table-striped table-dark"><thead><tr><th>Rank</th><th>Username</th><th>Score (%)</th><th>Out-of-browser Time (s)</th><th>Start</th><th>End</th><th>Duration (min)</th></tr></thead><tbody>';
        data.rankings.forEach(r => {
            const startTime = r.startTime ? new Date(r.startTime).toLocaleString() : 'N/A';
            const endTime = r.endTime ? new Date(r.endTime).toLocaleString() : 'N/A';
            const duration = r.duration ? Math.floor(r.duration / 1000 / 60) : 'N/A';
            
            html += `<tr>
                <td>${r.rank}</td>
                <td>${r.username}</td>
                <td>${r.score.toFixed(2)}</td>
                <td>${Math.floor(r.outOfBrowserTimeMs/1000)}</td>
                <td>${startTime}</td>
                <td>${endTime}</td>
                <td>${duration}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
    } catch (err) { 
        container.innerText = `Network error: ${err.message}`; 
    }
}
</script>
</body>
</html>